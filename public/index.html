<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <title>Prayer Beam</title>

    <link rel="icon" type="image/png" href="icon.png" />
    <link rel="apple-touch-icon" href="icon.png" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Crimson+Pro:wght@400;600&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- 1. SUPER APP VARIABLES --- */
      :root {
        --primary: #d32f2f;
        --bg: #ffffff;
        --surface: #f4f5f7;
        --text: #111827;
        --text-sub: #6b7280;
        --border: #e5e7eb;
        --nav-height: 65px;
        --safe-area-top: env(safe-area-inset-top);
      }

      [data-theme="dark"] {
        --bg: #000000;
        --surface: #1c1c1e;
        --text: #f3f4f6;
        --text-sub: #9ca3af;
        --border: #2c2c2e;
      }

      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
      }
      body {
        margin: 0;
        font-family: "Inter", sans-serif;
        background: var(--bg);
        color: var(--text);
        padding-bottom: 90px;
      }

      /* --- 2. HOME DASHBOARD (New!) --- */
      .home-header {
        padding: 20px;
        padding-top: max(20px, var(--safe-area-top));
      }
      .date-badge {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-sub);
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .greet-title {
        font-size: 28px;
        font-weight: 800;
        margin: 5px 0 20px 0;
      }

      /* Verse of the Day Card */
      .vod-card {
        background: linear-gradient(
          135deg,
          #ff9a9e 0%,
          #fecfef 99%,
          #fecfef 100%
        );
        border-radius: 20px;
        padding: 25px;
        color: #333;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
      }
      .vod-text {
        font-family: "Crimson Pro", serif;
        font-size: 22px;
        font-weight: 600;
        line-height: 1.4;
        margin-bottom: 15px;
      }
      .vod-ref {
        font-weight: 700;
        font-size: 14px;
        opacity: 0.7;
      }
      .btn-share-vod {
        margin-top: 15px;
        background: rgba(255, 255, 255, 0.3);
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        cursor: pointer;
        backdrop-filter: blur(5px);
      }

      /* Streak / Plan Section */
      .section-title {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .plan-card {
        background: var(--surface);
        border-radius: 16px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
      }
      .plan-ring {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 4px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 12px;
      }
      .plan-ring.done {
        border-color: #34d399;
        color: #34d399;
      }

      /* --- 3. BIBLE READER (Advanced) --- */
      .reader-header {
        position: sticky;
        top: 0;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        z-index: 100;
      }
      .book-pill {
        background: var(--surface);
        padding: 8px 16px;
        border-radius: 30px;
        font-weight: 700;
        font-size: 14px;
      }

      #verses-area {
        padding: 20px;
        max-width: 700px;
        margin: 0 auto;
      }
      .verse-block {
        font-family: "Crimson Pro", serif;
        font-size: 20px;
        line-height: 1.8;
        margin-bottom: 12px;
        padding: 2px 5px;
        border-radius: 4px;
        transition: 0.2s;
      }
      .v-idx {
        font-family: "Inter", sans-serif;
        font-size: 11px;
        color: var(--text-sub);
        font-weight: 700;
        vertical-align: super;
        margin-right: 4px;
      }

      /* Highlighting Colors */
      .hl-yellow {
        background: rgba(255, 235, 59, 0.4);
      }
      .hl-green {
        background: rgba(76, 175, 80, 0.3);
      }
      .hl-pink {
        background: rgba(233, 30, 99, 0.2);
      }

      /* --- 4. IMAGE CREATOR (Canvas) --- */
      #creator-canvas-container {
        width: 100%;
        aspect-ratio: 1;
        background: #333;
        margin: 20px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-radius: 12px;
      }
      #gen-canvas {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .color-dots {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
      }
      .color-dot {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        cursor: pointer;
      }

      /* --- 5. NAVIGATION (Tab Bar) --- */
      .tab-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: var(--nav-height);
        background: var(--bg);
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-around;
        align-items: center;
        z-index: 1000;
        padding-bottom: env(safe-area-inset-bottom);
      }
      .tab-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: var(--text-sub);
        font-size: 10px;
        font-weight: 600;
        background: none;
        border: none;
        width: 60px;
      }
      .tab-btn.active {
        color: var(--primary);
      }
      .tab-icon {
        font-size: 22px;
        margin-bottom: 3px;
      }

      /* --- UTILS --- */
      .view {
        display: none;
        padding-top: var(--safe-area-top);
      }
      .view.active {
        display: block;
        animation: fadeIn 0.2s;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .modal-sheet {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--bg);
        border-radius: 20px 20px 0 0;
        padding: 25px;
        box-shadow: 0 -5px 40px rgba(0, 0, 0, 0.2);
        transform: translateY(100%);
        transition: 0.3s;
        z-index: 2000;
      }
      .modal-sheet.open {
        transform: translateY(0);
      }

      .btn-primary {
        background: var(--text);
        color: var(--bg);
        padding: 12px;
        border-radius: 12px;
        text-align: center;
        font-weight: 600;
        margin-top: 10px;
        cursor: pointer;
      }
    </style>
  </head>
  <body data-theme="light">
    <div id="view-home" class="view active">
      <div class="home-header">
        <div class="date-badge" id="date-display">WEDNESDAY, JAN 28</div>
        <div class="greet-title">Good Morning</div>

        <div class="vod-card" id="vod-card">
          <div class="vod-text">
            "Your word is a lamp for my feet, a light on my path."
          </div>
          <div class="vod-ref">Psalm 119:105</div>
          <button class="btn-share-vod" onclick="openCreatorWithVod()">
            üé® Create Image
          </button>
        </div>

        <div class="section-title">
          <span>Daily Challenge</span>
          <span style="font-size: 12px; color: var(--primary)">View All</span>
        </div>
        <div class="plan-card" onclick="goToRead()">
          <div class="plan-ring" id="progress-ring">0%</div>
          <div>
            <div style="font-weight: 700">30 Days of Genesis</div>
            <div style="font-size: 12px; color: var(--text-sub)">
              Continue Day 1
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="view-read" class="view">
      <div class="reader-header">
        <div class="book-pill" onclick="openBookPicker()">Genesis 1 ‚ñº</div>
        <div style="display: flex; gap: 15px">
          <span onclick="toggleTheme()">üåó</span>
          <span onclick="toggleSettings()">Aa</span>
        </div>
      </div>
      <div id="verses-area">Loading...</div>

      <div id="context-menu" class="modal-sheet">
        <h3 style="margin-top: 0">Selected Verse</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px">
          <div
            class="color-dot hl-yellow"
            onclick="highlight('hl-yellow')"
          ></div>
          <div class="color-dot hl-green" onclick="highlight('hl-green')"></div>
          <div class="color-dot hl-pink" onclick="highlight('hl-pink')"></div>
          <div
            class="color-dot"
            style="
              background: #ddd;
              display: flex;
              align-items: center;
              justify-content: center;
            "
            onclick="highlight('')"
          >
            ‚úï
          </div>
        </div>
        <div class="btn-primary" onclick="createImageFromSelection()">
          üé® Create Verse Image
        </div>
      </div>
    </div>

    <div
      id="view-create"
      class="view"
      style="padding: 20px; background: #111; color: #fff; min-height: 100vh"
    >
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
        "
      >
        <button
          onclick="switchTab('home')"
          style="background: none; border: none; color: #fff"
        >
          ‚úï Cancel
        </button>
        <button
          onclick="downloadImage()"
          style="
            background: white;
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
          "
        >
          Save
        </button>
      </div>

      <div id="creator-canvas-container">
        <canvas id="gen-canvas" width="1080" height="1080"></canvas>
      </div>

      <div
        style="
          text-align: center;
          font-size: 12px;
          margin-bottom: 10px;
          opacity: 0.7;
        "
      >
        CHOOSE BACKGROUND
      </div>
      <div class="color-dots">
        <div
          class="color-dot"
          style="background: linear-gradient(45deg, #ff9a9e 0%, #fad0c4 99%)"
          onclick="bgType=0; drawCanvas()"
        ></div>
        <div
          class="color-dot"
          style="background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%)"
          onclick="bgType=1; drawCanvas()"
        ></div>
        <div
          class="color-dot"
          style="background: linear-gradient(to top, #30cfd0 0%, #330867 100%)"
          onclick="bgType=2; drawCanvas()"
        ></div>
        <div
          class="color-dot"
          style="background: #222"
          onclick="bgType=3; drawCanvas()"
        ></div>
      </div>
    </div>

    <nav class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('home')">
        <span class="tab-icon">üè†</span> Home
      </button>
      <button class="tab-btn" onclick="switchTab('read')">
        <span class="tab-icon">üìñ</span> Bible
      </button>
      <button class="tab-btn" onclick="switchTab('create')">
        <span class="tab-icon">üé®</span> Create
      </button>
    </nav>

    <script>
      // --- 1. STATE & DATA ---
      let state = JSON.parse(localStorage.getItem("pb_os")) || {
        bIdx: 0,
        cNum: 1,
        highlights: {},
        theme: "light",
      };
      let currentVerseText =
        "God is light; in him there is no darkness at all.";
      let currentVerseRef = "1 John 1:5";
      let bgType = 0;

      const bookNames = [
        "Genesis",
        "Exodus",
        "Leviticus",
        "Numbers",
        "Deuteronomy",
        "Joshua",
        "Judges",
        "Ruth",
        "1 Samuel",
      ]; // Shortened for demo
      const telNames = [
        "‡∞Ü‡∞¶‡∞ø‡∞ï‡∞æ‡∞Ç‡∞°‡∞Æ‡±Å",
        "‡∞®‡∞ø‡∞∞‡±ç‡∞ó‡∞Æ‡∞ï‡∞æ‡∞Ç‡∞°‡∞Æ‡±Å",
        "‡∞≤‡±á‡∞µ‡±Ä‡∞Ø‡∞ï‡∞æ‡∞Ç‡∞°‡∞Æ‡±Å",
        "‡∞∏‡∞Ç‡∞ñ‡±ç‡∞Ø‡∞æ‡∞ï‡∞æ‡∞Ç‡∞°‡∞Æ‡±Å",
      ];

      // --- 2. INIT ---
      window.onload = () => {
        updateDate();
        loadChapter();
        drawCanvas(); // Init the creator
      };

      function save() {
        localStorage.setItem("pb_os", JSON.stringify(state));
      }

      // --- 3. NAVIGATION ---
      function switchTab(view) {
        document
          .querySelectorAll(".view")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById("view-" + view).classList.add("active");

        // Hide Tab Bar in Creator Mode
        document.querySelector(".tab-bar").style.display =
          view === "create" ? "none" : "flex";
      }

      function updateDate() {
        const d = new Date();
        document.getElementById("date-display").innerText =
          d.toLocaleDateString("en-US", {
            weekday: "long",
            month: "short",
            day: "numeric",
          });
      }

      // --- 4. BIBLE ENGINE ---
      async function loadChapter() {
        const container = document.getElementById("verses-area");
        container.innerHTML = "Loading...";

        // Fetch Telugu Bible (using Git API)
        const res = await fetch(
          `https://cdn.jsdelivr.net/gh/aruljohn/Bible-telugu@master/Genesis.json`
        );
        const data = await res.json();
        const verses = data.chapters[state.cNum - 1].verses;

        let html = "";
        verses.forEach((v, i) => {
          const vNum = i + 1;
          const hlClass =
            state.highlights[`${state.bIdx}-${state.cNum}-${vNum}`] || "";

          html += `<div class="verse-block ${hlClass}" onclick="openContext('${v.text}', '${vNum}')">
                    <span class="v-idx">${vNum}</span> ${v.text}
                </div>`;
        });
        container.innerHTML = html;
      }

      // --- 5. CONTEXT MENU (Highlighting) ---
      let selectedVerseNum = null;
      function openContext(text, num) {
        currentVerseText = text;
        currentVerseRef = `Genesis 1:${num}`; // Dynamic ref in real app
        selectedVerseNum = num;
        document.getElementById("context-menu").classList.add("open");
      }

      function highlight(color) {
        const key = `${state.bIdx}-${state.cNum}-${selectedVerseNum}`;
        if (color) state.highlights[key] = color;
        else delete state.highlights[key];

        save();
        loadChapter(); // Redraw
        document.getElementById("context-menu").classList.remove("open");
      }

      // --- 6. IMAGE GENERATOR (Canvas Logic) ---
      function createImageFromSelection() {
        document.getElementById("context-menu").classList.remove("open");
        switchTab("create");
        drawCanvas();
      }

      function openCreatorWithVod() {
        currentVerseText =
          "Your word is a lamp for my feet, a light on my path.";
        currentVerseRef = "Psalm 119:105";
        switchTab("create");
        drawCanvas();
      }

      function drawCanvas() {
        const canvas = document.getElementById("gen-canvas");
        const ctx = canvas.getContext("2d");

        // 1. Draw Background
        const w = canvas.width,
          h = canvas.height;
        let grad;

        if (bgType === 0) grad = ctx.createLinearGradient(0, 0, w, h); // Pink
        else if (bgType === 1)
          grad = ctx.createLinearGradient(0, 0, 0, h); // Blue
        else if (bgType === 2)
          grad = ctx.createLinearGradient(0, h, w, 0); // Purple
        else grad = "#111"; // Black

        if (bgType !== 3) {
          const colors = [
            ["#ff9a9e", "#fecfef"],
            ["#a1c4fd", "#c2e9fb"],
            ["#30cfd0", "#330867"],
          ];
          grad.addColorStop(0, colors[bgType][0]);
          grad.addColorStop(1, colors[bgType][1]);
        }

        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, w, h);

        // 2. Draw Text
        ctx.fillStyle = bgType === 3 ? "white" : "#333";
        if (bgType === 2) ctx.fillStyle = "white";

        ctx.font = "bold 60px 'Crimson Pro'";
        ctx.textAlign = "center";

        // Text Wrapping Logic
        const words = currentVerseText.split(" ");
        let line = "";
        let y = h / 2 - 100;

        words.forEach((word) => {
          const testLine = line + word + " ";
          if (ctx.measureText(testLine).width > w - 200) {
            ctx.fillText(line, w / 2, y);
            line = word + " ";
            y += 80;
          } else {
            line = testLine;
          }
        });
        ctx.fillText(line, w / 2, y);

        // 3. Draw Reference
        ctx.font = "40px 'Inter'";
        ctx.fillText(currentVerseRef, w / 2, y + 100);

        // 4. Branding
        ctx.font = "30px 'Inter'";
        ctx.globalAlpha = 0.6;
        ctx.fillText("PRAYER BEAM", w / 2, h - 50);
        ctx.globalAlpha = 1.0;
      }

      function downloadImage() {
        const link = document.createElement("a");
        link.download = "prayer-beam-verse.png";
        link.href = document.getElementById("gen-canvas").toDataURL();
        link.click();
      }

      // --- 7. UTILS ---
      function toggleTheme() {
        const themes = ["light", "dark"];
        state.theme = state.theme === "light" ? "dark" : "light";
        document.body.setAttribute("data-theme", state.theme);
        save();
      }
      document.body.setAttribute("data-theme", state.theme); // Apply on load
    </script>
  </body>
</html>
